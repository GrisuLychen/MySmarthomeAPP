<script>
    // Mapping der Lampen-IDs zu ihren Befehlspräfixen
    const LIGHTS = {
        'decke': 'decke',
        'backlight': 'backlight',
        'video': 'video'
    };

    // Funktion, die den Befehl an den Telegram Bot sendet
    function sendCommand(command) {
        if (window.Telegram && window.Telegram.WebApp) {
            // Sende die Daten an den Bot (Der Client sollte nun entscheiden, ob er die App schließt)
            window.Telegram.WebApp.sendData(command); 
            
            // WICHTIG: window.Telegram.WebApp.close(); wurde hier entfernt.
        } else {
            console.error("Telegram WebApp SDK nicht geladen oder private Umgebung.");
            alert(`Simuliere Befehl: ${command}`);
        }
    }

    // --- 1. Event-Listener für Lampenschalter ---
    for (const id in LIGHTS) {
        const switchElement = document.getElementById(`switch_${id}`);
        const bulbElement = document.getElementById(`bulb_${id}`);

        if (switchElement && bulbElement) {
            switchElement.addEventListener('change', function() {
                const action = this.checked ? 'ein' : 'aus';
                const command = `!twa_${LIGHTS[id]}_${action}`;
                
                // Visuellen Zustand der Glühbirne anpassen
                bulbElement.classList.toggle('on', this.checked);
                
                sendCommand(command);
            });
        }
    }

    // --- 2. Event-Listener für Rollo Buttons ---
    const rollerButtons = document.querySelectorAll('#rollerSection button');
    rollerButtons.forEach(button => {
        button.addEventListener('click', function() {
            const command = this.getAttribute('data-command');
            sendCommand(command);
        });
    });

    // --- 3. TWA Initialisierung ---
    if (window.Telegram && window.Telegram.WebApp) {
         window.Telegram.WebApp.ready();
    } 
</script>


